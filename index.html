<html>
<body>
	<link rel="stylesheet" href="cssgram.min.css">
	<script src="ImageOpener.js"></script>

	<div id="filters"></div>
	<div id="peeks"></div>

	<div id="sliders"></div>

	<div id="drop">drop photos here.....
		<div id="big"></div>

		<!--<svg id="big" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
		</svg>-->


		<br/>
		<div id="preview"></div>
	</div>

	<!--
		initial potatoe prototype from http://jabtunes.com/labs/potatoe/ series
	-->

	<style>
		body {
			background-color: #333740;
			color: #ddd;
			font-size: 13px;
		}
		.pic {
			max-height: 320px;
			max-width: 320px;

			margin: 5px;
		}

		.peek {
			max-height: 120px;
			max-width: 120px;
			float: left;
			margin: 2px;
		}

		.big {
			max-height: 590px;
			max-width: 590px;
		}

		.orig {
			max-height: 590px;
			max-width: 590px;
		}

		button {
			padding: 8px;
			margin: 4px 4px 14px 4px;
			background-image: linear-gradient(-180deg, #7B7E87 0%, #555862 100%);
			border: 1px solid #292B31;
			box-shadow: 0px 1px 5px 0px rgba(0, 0, 0, 0.30), inset 0px 1px 0px 0px rgba(255, 255, 255, 0.60);
			border-radius: 4px;
			color: #eaeaea;
		}

		button:active {
			box-shadow: 0px 1px 1px 0px rgba(255, 255, 255, 0.30), inset 0px 0px 4px 0px rgba(0, 0, 0, 0.80);
		}

		button:hover {
			background-image: -webkit-linear-gradient(#BDC2D0 0%, #656874 100%);
			background-image: -o-linear-gradient(#BDC2D0 0%, #656874 100%);
			background-image: linear-gradient(#BDC2D0 0%, #656874 100%);
		}

		img {
			border: 1px solid transparent;
		}

		img:hover {
			border: 1px solid #ddd;
		}

		#big {
			display: inline-block;
			width: 590px;
			height: 390px;
		}

		.dotted-border {
			width: 360px;
			height: 230px;
			border: 2px dotted #676B78;
			border-radius: 4px;
		}

		.txt-drag-your-photos-here {
			font-size: 15px;
			color: #898D9B;
		}

		#sliders {
			right: 0px;
			width: 200px;
			position: absolute;
			background:rgba(0, 0, 0, 0.30);
		}

	</style>

	<script>

		var opener = new ImageOpener(processImage);
		var count = 0;
		var maxLength = 240;

		var preview = document.getElementById('preview');
		var filters = document.getElementById('filters');
		var peeks = document.getElementById('peeks');
		var big = document.getElementById('big'), bigimg;

		var styles = [
			"nofilter",
			"aden",
			"reyes",
			"perpetua",
			"inkwell",
			"earlybird",
			"toaster",
			"walden",
			"hudson",
			"gingham",
			"mayfair",
			"lofi",
			"xpro2",
			"_1977",
			"brooklyn",
			"nashville",
			"lark",
			"moon"
		];

		var currentStyle = 'nofilter';
		var saved;

		styles.forEach( function(s) {
			var b = document.createElement('button');
			b.innerHTML = s;

			b.onclick = function() {
				saved = currentStyle;
				switchStyle(s);
			}

			b.onmouseover = function() {
				saved = currentStyle;
				switchStyle(s);
			}

			b.onmouseout = function() {
				switchStyle(saved);
			}

			filters.appendChild(b);
		} )


		function switchStyle(s) {
			var old = currentStyle;

			var pics = document.querySelectorAll('.pic, .big')

			for (var i = 0; i < pics.length; i ++) {
				var p = pics[i];
				p.classList.remove(old);
				p.classList.add(s);
			}

			currentStyle = s;
		}

		var all = [];

		var x = 0;

		var tmp;
		var save;

		var img = big;
		var lasty;


		img.onmouseover = function(e) {
			save = currentStyle;
		}

		img.onmousemove = function(e) {
			if (!bigimg) return;
			var x = e.offsetX / bigimg.width;
			var y = (e.offsetY / 3 | 0) % all.length;
			if (lasty === undefined) lasty = y;

			// var s = styles[x * styles.length | 0];

			tmp = bigimg.classList[1];

			// bigimg.classList.remove(tmp);
			// bigimg.classList.add(s);

			// bigimg.style.cssText = 'clip: rect(auto auto auto ' + (e.offsetX | 0) + 'px)';

			if (lasty != y) {
				// previewBig(all[y]);
				lasty = y;
			}
		}

		img.onmouseout = function(e) {
			if (!bigimg) return;
			tmp = bigimg.classList[1];
			bigimg.classList.remove(tmp);
			bigimg.classList.add(currentStyle);

		}

		img.onmousedown = function(e) {
			save = bigimg.classList[1];
			switchStyle(save);
		}

		function previewBig(img) {
			// img = scaleImage(img, 590);

			var child;
			while (child = big.childNodes[0]) {
				child.remove();
			}

			while (child = peeks.childNodes[0]) {
				child.remove();
			}

			// original
			// var n = document.createElement('figure');
			// n.appendChild(img.cloneNode());
			// n.classList.remove(n.classList[0]);
			// n.classList.remove(n.classList[0]);
			// n.classList.add('orig');
			// big.appendChild(n);

			//
			// big.innerHTML = '<image x="0" y="0" width="275" height="95" xlink:href="' + img.src + '" />'
			n = document.createElement('figure');
			n.appendChild(img.cloneNode());
			// n.classList.remove(n.classList[0]);
			// n.classList.remove(n.classList[0]);
			n.classList.add('big');
			n.classList.add(currentStyle);
			bigimg = n;

			big.appendChild(n);

			// big.style.width = n.width + 'px';
			// big.style.height = n.height + 'px';

			img = scaleImage(img, maxLength);

			styles.forEach(function(s) {
				var m = document.createElement('figure');
				m.appendChild(img.cloneNode());

				while (m.classList.length) {
					m.classList.remove(m.classList[0]);
				}
				m.classList.add('peek');
				m.classList.add(s);

				m.onmousedown = function() {
					saved = currentStyle;
					switchStyle(s);
				}

				m.onmouseover = function() {
					console.log(s);
					saved = currentStyle;
					switchStyle(s);
				}

				m.onmouseout = function() {
					switchStyle(saved);
				}

				peeks.appendChild(m);
			});

		}

		function scaleImage(img, maxLength) {
			var canvas = getCanvas(img, maxLength);

			var image = new Image();
			image.src = canvas.toDataURL("image/png");

			return image;
		}

		function getCanvas(img, maxLength) {
			var scale = img.width > img.height ? maxLength / img.width : maxLength / img.height;

			var canvas = document.createElement('canvas');
			var ctx = canvas.getContext('2d');

			var targetWidth = img.width * scale;
			var targetHeight = img.height * scale;
			canvas.width = targetWidth;
			canvas.height = targetHeight;
			ctx.drawImage(img, 0, 0, targetWidth, targetHeight);

			return canvas;
		}

		function processImage(img) {
			// console.log('process image');

			var canvas = getCanvas(img, 550);
			inlineSVGImg(canvas.toDataURL(), canvas.width, canvas.height);

			// previewBig(img);

			img = scaleImage(img, 390);

			all.push(img);

			img.classList.add('pic');
			img.classList.add(currentStyle);

			// var figure = document.createElement('figure');
			// figure.appendChild(img);
			// preview.appendChild(figure);

			img.onclick = function() {
				previewBig(this);
			}

		}

	</script>

	<script>

function inlineSVGImg(data, width, height) {
	width = width || 20;
	hight = height || 20;
	var div = document.createElement('div');

	var svg = `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
		 id="test" width="${width}" height="${height}" >
		 <defs>
			<!-- https://docs.webplatform.org/wiki/svg/tutorials/smarter_svg_filters -->
			<filter id="effect">
			</filter>
			<filter id="css_blur">
				<feGaussianBlur stdDeviation="10"/>
			</filter>
			<filter id="sideways_blur">
				<feGaussianBlur stdDeviation="10 1"/>
			</filter>

			<filter id="posterize">
				<feComponentTransfer>
					<feFuncR type="discrete"
						tableValues="0 0.2 0.4 0.6 0.8 1"/>
					<feFuncG type="discrete"
						tableValues="0 0.2 0.4 0.6 0.8 1"/>
					<feFuncB type="discrete"
						tableValues="0 0.2 0.4 0.6 0.8 1"/>
				</feComponentTransfer>
			</filter>

			<filter id="no_op">
				<feComponentTransfer>
					<feFuncR type="identity"/>
					<feFuncG type="identity"/>
					<feFuncB type="identity"/>
					<feFuncA type="identity"/>
				</feComponentTransfer>
			</filter>
		</defs>
		<style>
		/* <![CDATA[ */
		.testing {
			filter: url(#posterize);
		}
		/* ]]> */
		</style>

 <!-- filter="url(#effect)"   filter="url(#css_blur)" -->
		<image class="testing" width="${width}" height="${height}" xlink:href="data:image/png;${data}"/>
	</svg>`;

	console.log(svg);

	div.innerHTML = svg;

	// proxy svg image
	var img = new Image()
	img.src = 'data:image/svg+xml;utf8,' + svg

	// write svg image to canvas for pixels
	var canvas = document.createElement('canvas');
	canvas.width = width;
	canvas.height = height;
	var context = canvas.getContext('2d');

	context.drawImage(img, 0, 0, width, height);
	// var a = document.createElement("a");
	// a.download = 'test.png';
	// a.href = canvas.toDataURL("image/png");
	// a.click()
	// z = cc.getImageData(0,0,c.width, c.height)


	document.body.appendChild(div);
}

</script>

</body>
</html>