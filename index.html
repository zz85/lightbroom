<html>
	<head>
		<title>Lightbroom Preview</title>
	</head>
<body>
	<link rel="stylesheet" href="cssgram.min.css">
	<script src="ImageOpener.js"></script>

	<div id="filters"></div>
	<div id="peeks"></div>

	<div id="sliders"></div>

	<div id="drop">
		<div>
			drop photos here.....
		</div>
		<div id="big"></div>

		<!--<svg id="big" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
		</svg>-->


		<br/>
		<div id="preview"></div>
	</div>

	<!--
		initial potatoe prototype from http://jabtunes.com/labs/potatoe/ series
	-->

	<style>
		body {
			background-color: #333740;
			color: #ddd;
			font-size: 13px;
		}
		.pic {
			max-height: 320px;
			max-width: 320px;

			margin: 5px;

			float: left;
		}

		.peek {
			max-height: 120px;
			max-width: 120px;
			float: left;
			margin: 2px;
		}

		.big {
			max-height: 590px;
			max-width: 590px;
		}

		.orig {
			max-height: 590px;
			max-width: 590px;
		}

		.nofilter > img {
			max-height: 120px;
			max-width: 120px;
		}

		#filters {
			display: flex;
			border-bottom: 1px solid grey;
			overflow: scroll;
		}

		button {
			padding: 8px;
			margin: 4px 4px 14px 4px;
			background-image: linear-gradient(-180deg, #7B7E87 0%, #555862 100%);
			border: 1px solid #292B31;
			box-shadow: 0px 1px 5px 0px rgba(0, 0, 0, 0.30), inset 0px 1px 0px 0px rgba(255, 255, 255, 0.60);
			border-radius: 4px;
			color: #eaeaea;
		}

		.effect {
			width: 120px;
			display: block;
			text-align: center;
			font-weight: bold;
			background: #111;
			display: block;

		}

		button:active {
			box-shadow: 0px 1px 1px 0px rgba(255, 255, 255, 0.30), inset 0px 0px 4px 0px rgba(0, 0, 0, 0.80);
		}

		button:hover {
			background-image: -webkit-linear-gradient(#BDC2D0 0%, #656874 100%);
			background-image: -o-linear-gradient(#BDC2D0 0%, #656874 100%);
			background-image: linear-gradient(#BDC2D0 0%, #656874 100%);
		}

		img {
			border: 1px solid transparent;
		}

		img:hover {
			border: 1px solid #ddd;
		}

		#big {
			display: inline-block;
			width: 590px;
			height: 390px;
		}

		.dotted-border {
			width: 360px;
			height: 230px;
			border: 2px dotted #676B78;
			border-radius: 4px;
		}

		.txt-drag-your-photos-here {
			font-size: 15px;
			color: #898D9B;
		}

		#sliders {
			right: 0px;
			width: 200px;
			position: absolute;
			background:rgba(0, 0, 0, 0.30);
		}

		#preview {
			/*display: flex;
			overflow: scroll;*/
		}

	</style>

	<script>

		var opener = new ImageOpener(processImage);
		var count = 0;
		var maxLength = 240;

		var preview = document.getElementById('preview');
		var filters = document.getElementById('filters');
		var peeks = document.getElementById('peeks');
		var big = document.getElementById('big'), bigimg;

		var styles = [
			"nofilter",
			"aden",
			"reyes",
			"perpetua",
			"inkwell",
			"earlybird",
			"toaster",
			"walden",
			"hudson",
			"gingham",
			"mayfair",
			"lofi",
			"xpro2",
			"_1977",
			"brooklyn",
			"nashville",
			"lark",
			"moon"
		];

		var currentStyle = 'nofilter';
		var saved;
		var filterItems = new Map();

		styles.forEach( function(s) {
			var div = document.createElement('div');

			var b = document.createElement('b');
			b.className = 'effect';
			b.innerHTML = s;

			b.onclick = function() {
				saved = currentStyle;
				switchStyle(s);
			}

			b.onmouseover = function() {
				saved = currentStyle;
				switchStyle(s);
			}

			b.onmouseout = function() {
				switchStyle(saved);
			}

			div.appendChild(b);

			var figure = document.createElement('figure');
			b.appendChild(figure);

			filterItems.set(s, div);
			filters.appendChild(div);
		} )


		function switchStyle(s) {
			var old = currentStyle;

			var pics = document.querySelectorAll('.pic, .big')

			for (var i = 0; i < pics.length; i ++) {
				var p = pics[i];
				p.classList.remove(old);
				p.classList.add(s);
			}

			currentStyle = s;
		}

		var all = [];

		var x = 0;

		var tmp;
		var save;

		var img = big;
		var lasty;


		img.onmouseover = function(e) {
			save = currentStyle;
		}

		img.onmousemove = function(e) {
			if (!bigimg) return;
			var x = e.offsetX / bigimg.width;
			var y = (e.offsetY / 3 | 0) % all.length;
			if (lasty === undefined) lasty = y;

			// var s = styles[x * styles.length | 0];

			tmp = bigimg.classList[1];

			// bigimg.classList.remove(tmp);
			// bigimg.classList.add(s);

			// bigimg.style.cssText = 'clip: rect(auto auto auto ' + (e.offsetX | 0) + 'px)';

			if (lasty != y) {
				// previewBig(all[y]);
				lasty = y;
			}
		}

		img.onmouseout = function(e) {
			if (!bigimg) return;
			tmp = bigimg.classList[1];
			bigimg.classList.remove(tmp);
			bigimg.classList.add(currentStyle);

		}

		img.onmousedown = function(e) {
			save = bigimg.classList[1];
			switchStyle(save);
		}

		function previewBig(img) {
			img = scaleImage(img, 590);

			var child;
			while (child = big.childNodes[0]) {
				child.remove();
			}

			// original
			// var n = document.createElement('figure');
			// n.appendChild(img.cloneNode());
			// n.classList.remove(n.classList[0]);
			// n.classList.remove(n.classList[0]);
			// n.classList.add('orig');
			// big.appendChild(n);

			//
			// big.innerHTML = '<image x="0" y="0" width="275" height="95" xlink:href="' + img.src + '" />'
			n = document.createElement('figure');
			n.appendChild(img.cloneNode());
			// n.classList.remove(n.classList[0]);
			// n.classList.remove(n.classList[0]);
			n.classList.add('big');
			n.classList.add(currentStyle);
			bigimg = n;

			big.appendChild(n);

			// big.style.width = n.width + 'px';
			// big.style.height = n.height + 'px';

			img = scaleImage(img, maxLength);

			styles.forEach(function(s) {
				var m = filterItems.get(s).querySelector('figure');

				while (child = m.childNodes[0]) {
					child.remove();
				}

				m.appendChild(img.cloneNode());

				while (m.classList.length) {
					m.classList.remove(m.classList[0]);
				}
				m.classList.add('peek');
				m.classList.add(s);

			});

		}

		function scaleImage(img, maxLength) {
			var canvas = getCanvas(img, maxLength);

			var image = new Image();
			image.src = canvas.toDataURL("image/png");

			return image;
		}

		function getCanvas(img, maxLength) {
			var scale = img.width > img.height ? maxLength / img.width : maxLength / img.height;

			var canvas = document.createElement('canvas');
			var ctx = canvas.getContext('2d');

			var targetWidth = img.width * scale;
			var targetHeight = img.height * scale;
			canvas.width = targetWidth;
			canvas.height = targetHeight;
			ctx.drawImage(img, 0, 0, targetWidth, targetHeight);

			return canvas;
		}

		function processImage(oImg) {
			// console.log('process image');

			// var canvas = getCanvas(img, 550);
			// inlineSVGImg(canvas.toDataURL(), canvas.width, canvas.height);

			previewBig(oImg);

			img = scaleImage(oImg, 390);

			all.push(img);

			var figure = document.createElement('figure');
			figure.classList.add('pic');
			figure.classList.add(currentStyle);
			figure.appendChild(img);

			preview.appendChild(figure);

			img.onclick = function() {
				previewBig(oImg);
			}

		}

	</script>

</body>
</html>